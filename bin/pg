#!/usr/bin/env bash

PGHOST="${PGHOSTADDR:-${PGHOST:-127.0.0.1}}"
PGPORT="${PGPORT:-5432}"
PGUSER="${PGUSER:-${POSTGRES_USER:-postgres}}"

export PGHOST PGPORT PGUSER

PGPASSWORD="${PGPASSWORD:-${POSTGRES_PASSWORD:-}}" && {
    [[ -n ${PGPASSWORD} ]] && export PGPASSWORD
}

PGDATABASE="${PGDATABASE:-${POSTGRES_DB:-}}" && {
    [[ -n ${PGDATABASE} ]] && export PGDATABASE
}

PG_BACKUPS_DIR="${POSTGRES_PGBACKUPS_DIR:-/var/backups/postgresql}"

pg_backup_dump_main() {
    echo "pg_backup_dump_main"

    exit
}

pg_backup_restore_main() {
    echo "pg_backup_restore_main"

    exit
}

pg_backup_show_help() {
    echo "no help entry"
}

pg_backup_main() {
    if [[ $# -eq 0 ]]; then
        pg_backup_show_help

        exit 1
    fi

    while [[ $# -gt 0 ]]; do
        case "$1" in
            dump)
                shift
                pg_backup_dump_main "$@"
                ;;
            restore)
                shift
                pg_backup_restore_main "$@"
                ;;
            *)
                echo "${BASH_SOURCE[0]}: invalid command" >&2

                exit 1
                ;;
        esac
    done
}

pg_con_main() {
    exec psql "$@"
}

pg_show_help() {
    echo "no help entry"
}

pg_main() {
    if [[ $# -eq 0 ]]; then
        pg_show_help

        exit 1
    fi

    while [[ $# -gt 0 ]]; do
        case "$1" in
            backup)
                shift
                pg_backup_main "$@"
                ;;
            con)
                shift
                pg_con_main "$@"
                ;;
            *)
                echo "${BASH_SOURCE[0]}: invalid command" >&2

                exit 1
                ;;
        esac
    done
}

pg_main "$@"
