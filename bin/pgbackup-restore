#!/usr/bin/env bash

__DIR__="$(dirname -- "${BASH_SOURCE[0]}")"

if ! command -v pg_restore >/dev/null; then
    echo "no pg_dump" >&2

    exit 1
fi

SRC="$(dirname -- "${__DIR__}")/src"

source "${SRC}/pg/envs.bash" || {
    exit 1
}

main() {
    declare defaultDb="${PGDATABASE:-}" arg

    for arg in "$@"; do
        if [[ "${arg}" =~ ^(-d|--dbname)$ ]]; then
            defaultDb=""

            break
        fi
    done

    if [[ -n "${defaultDb}" ]]; then
        declare confirmation

        echo -n "Database was not specified, do you want restore into ${defaultDb^^} database ? [y/N]: "
        read -r -n1 confirmation
        echo ""

        if ! [[ "${confirmation}" =~ ^[yY]$ ]]; then
            echo "Exiting..."

            exit 0
        fi

        echo "Proceeding..."

        set -- --dbname "${defaultDb}" "$@"
    fi

    pg_restore "$@"
}

main "$@"
